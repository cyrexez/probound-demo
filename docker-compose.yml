version: '3.8'

services:
  # The Reverse Proxy (Entry Point)
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - agent-service

  # The FastAPI App (Internal)
  agent-service:
    build: .
    # No "ports" section here; Nginx handles the ingress
    deploy:
      replicas: 4 # Scale horizontally
    environment:
      - WORKERS=4

  # The Load Tester
  load-tester:
    image: locustio/locust
    ports:
      - "8089:8089"
    volumes:
      - ./:/mnt/locust
    command: -f /mnt/locust/locust.py